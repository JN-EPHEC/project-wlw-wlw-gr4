{
  "phase": 2,
  "status": "STRUCTURE_STANDARDISEE_COMPLETE",
  "analysis_date": "2025-12-17",
  "project": "project-wlw-wlw-gr4",
  "collection": "notifications",
  "files_created": [
    {
      "path": "types/Notification.ts",
      "purpose": "Interfaces TypeScript strictes pour toutes les notifications",
      "exports": [
        "NotificationType",
        "RecipientType",
        "RelatedType",
        "Notification",
        "CreateNotificationDTO",
        "PushNotificationPayload",
        "notificationTemplates"
      ]
    },
    {
      "path": "utils/notificationHelpers.ts",
      "purpose": "Helpers pour créer les notifications",
      "key_functions": [
        "createNotification()",
        "createNotificationFromTemplate()",
        "notifyClubNewMemberRequest()",
        "notifyUserMembershipApproved()",
        "notifyClubNewBooking()",
        "notifyUserBookingConfirmed()"
      ]
    },
    {
      "path": "hooks/useNotifications.ts",
      "purpose": "Hooks pour lire et gérer les notifications",
      "key_hooks": [
        "useNotifications(userId)",
        "useUnreadNotificationCount(userId)",
        "useClubNotifications(clubId)"
      ]
    },
    {
      "path": "NOTIFICATION_DEPLOYMENT_PLAN.md",
      "purpose": "Plan détaillé avec diagrammes des flux"
    }
  ],
  "notification_types_found": [
    {
      "type": "pending_member_request",
      "examples_count": 1,
      "fields": [
        "clubId",
        "type",
        "title",
        "message",
        "userId",
        "userName",
        "createdAt",
        "read"
      ],
      "used_in": [
        "hooks/useJoinClub.ts"
      ],
      "description": "Notification créée lorsqu'un utilisateur demande à rejoindre un club. Destinée au club admin pour informer d'une nouvelle demande d'adhésion.",
      "example_data": {
        "clubId": "string",
        "type": "pending_member_request",
        "title": "Nouvelle demande d'adhésion",
        "message": "{userName} demande à rejoindre votre club",
        "userId": "string (user ID)",
        "userName": "string",
        "createdAt": "Timestamp",
        "read": "boolean"
      },
      "field_naming_note": "Utilise 'read' (pas 'isRead')"
    },
    {
      "type": "rating",
      "examples_count": 1,
      "fields": [
        "id",
        "type",
        "title",
        "message",
        "time",
        "isRead",
        "icon",
        "iconColor",
        "bg",
        "bookingId"
      ],
      "used_in": [
        "app/notifications.tsx"
      ],
      "description": "Invitation à donner un avis/note après une séance de formation. Affichée en UI, c'est un exemple de prototype.",
      "example_data": {
        "id": 1,
        "type": "rating",
        "title": "Donnez votre avis !",
        "message": "Comment s'est passée votre séance au Canin Club Paris ?",
        "time": "Il y a 2 heures",
        "isRead": false,
        "icon": "star",
        "iconColor": "#E9B782",
        "bg": "#FEF3C7",
        "bookingId": 501
      },
      "field_naming_note": "Utilise 'isRead' (pas 'read')"
    },
    {
      "type": "club",
      "examples_count": 2,
      "fields": [
        "id",
        "type",
        "title",
        "message",
        "time",
        "isRead",
        "icon",
        "iconColor",
        "bg",
        "clubId",
        "club"
      ],
      "used_in": [
        "app/notifications.tsx"
      ],
      "description": "Notifications liées aux clubs: réservations confirmées, nouveaux événements, annonces importantes. Peut couvrir plusieurs sous-types.",
      "example_data": [
        {
          "id": 2,
          "type": "club",
          "title": "Réservation confirmée !",
          "message": "Séance du 2 novembre à 14h00 avec Sophie Martin confirmée.",
          "time": "Il y a 3 heures",
          "isRead": false,
          "icon": "checkmark-circle",
          "iconColor": "#16A34A",
          "bg": "#ECFDF3",
          "clubId": 101,
          "club": {
            "name": "Canin Club Paris",
            "logo": "https://images.unsplash.com/..."
          }
        },
        {
          "id": 3,
          "type": "club",
          "title": "Nouvel événement !",
          "message": "Compétition Agility - Grand Prix 2024 ouverte aux inscriptions.",
          "time": "Hier",
          "isRead": false,
          "icon": "trophy",
          "iconColor": "#7C3AED",
          "bg": "#F3E8FF",
          "clubId": 202,
          "club": {
            "name": "Agility Pro",
            "logo": "https://images.unsplash.com/..."
          }
        }
      ],
      "field_naming_note": "Utilise 'isRead' (pas 'read')"
    },
    {
      "type": "message",
      "examples_count": 1,
      "fields": [
        "id",
        "type",
        "title",
        "message",
        "time",
        "isRead",
        "icon",
        "iconColor",
        "bg"
      ],
      "used_in": [
        "app/notifications.tsx"
      ],
      "description": "Notifications de nouveaux messages dans les canaux de discussion communautaires. Exemple: messages reçus dans les salons de chat.",
      "example_data": {
        "id": 4,
        "type": "message",
        "title": "Nouveau message !",
        "message": "Sophie vous a écrit dans #conseils.",
        "time": "Il y a 2 jours",
        "isRead": true,
        "icon": "chatbubble-ellipses",
        "iconColor": "#F28B6F",
        "bg": "#FFF7ED"
      },
      "field_naming_note": "Utilise 'isRead' (pas 'read')"
    }
  ],
  "field_inconsistencies": [
    {
      "issue": "Incohérence de nommage du champ 'read' vs 'isRead'",
      "severity": "HAUTE",
      "locations": [
        {
          "location": "hooks/useJoinClub.ts:read",
          "uses": "read: false"
        },
        {
          "location": "app/notifications.tsx:isRead",
          "uses": "isRead: false"
        }
      ],
      "impact": "Risque d'erreurs d'interrogation Firebase et de filtrage des notifications non lues. Le code de l'écran ne pourrait pas correctement récupérer les notifications créées par useJoinClub car il rechercherait 'isRead' alors que le document contient 'read'.",
      "recommendation": "Standardiser sur un seul nom: soit 'read' soit 'isRead' dans toute la collection. Préférer 'isRead' car c'est la convention TypeScript pour les booléens."
    },
    {
      "issue": "Écran de notifications utilise des données mockées (initialNotifications) et ne récupère pas les données réelles de Firestore",
      "severity": "CRITIQUE",
      "locations": [
        "app/notifications.tsx"
      ],
      "impact": "L'écran affiche uniquement 4 notifications en dur. Les vraies notifications créées par useJoinClub et autres hooks ne s'affichent jamais à l'utilisateur. La fonctionnalité est complètement déconnectée de la base de données.",
      "recommendation": "Implémenter un hook useNotifications() qui écoute les changements en temps réel de la collection 'notifications' et met à jour l'état."
    },
    {
      "issue": "Structure hétérogène des notifications: UI vs. Backend",
      "severity": "MOYENNE",
      "locations": [
        "app/notifications.tsx (UI)",
        "hooks/useJoinClub.ts (Backend)"
      ],
      "impact": "Les notifications créées au backend (pending_member_request) n'ont pas les mêmes champs que celles attendues par l'UI (icon, iconColor, bg, etc.). Les notifications ne s'afficheraient pas correctement.",
      "recommendation": "Définir une interface TypeScript cohérente pour les notifications en backend et frontend."
    },
    {
      "issue": "Absence de champ 'targetId' ou 'targetRef' pour redirection",
      "severity": "MOYENNE",
      "locations": [
        "hooks/useJoinClub.ts",
        "app/notifications.tsx"
      ],
      "impact": "Les notifications ne contiennent pas de références claires vers les ressources concernées. Dans l'UI, le type 'rating' utilise 'bookingId' mais les autres types (club, message, pending_member_request) utilisent 'clubId' ou rien. Impossible de naviguer de manière cohérente.",
      "recommendation": "Ajouter des champs systématiques: targetId, targetType (pour identifier le type de ressource) et targetRoute (pour la navigation)."
    },
    {
      "issue": "Champ 'time' calculé en UI vs. 'createdAt' en Backend",
      "severity": "BASSE",
      "locations": [
        "app/notifications.tsx (time: string relatif)",
        "hooks/useJoinClub.ts (createdAt: Timestamp)"
      ],
      "impact": "Incohérence dans la représentation du temps. Les données mockées utilisent des chaînes relatives ('Il y a 2 heures') tandis que les vraies notifications utiliseront des Timestamps. Le frontend devra convertir les Timestamps.",
      "recommendation": "Utiliser toujours Timestamp dans Firestore et convertir en affichage relatif dans le composant d'affichage."
    },
    {
      "issue": "Absence de champs de ciblage d'utilisateur",
      "severity": "MOYENNE",
      "locations": [
        "hooks/useJoinClub.ts",
        "hooks/useApproveOrRejectMember.ts"
      ],
      "impact": "Les notifications ne spécifient pas clairement à qui elles sont destinées. Le champ 'userId' dans pending_member_request est l'utilisateur qui fait la demande, pas le destinataire. Les admin/club owners reçoivent-ils automatiquement ces notifications?",
      "recommendation": "Ajouter 'recipientId' et 'recipientRole' pour filtrer explicitement les notifications par utilisateur."
    },
    {
      "issue": "Absence de champ 'actionRequired' ou 'actionType'",
      "severity": "MOYENNE",
      "locations": [
        "Toute la collection"
      ],
      "impact": "On ne sait pas si la notification est informative ou si elle nécessite une action. Les notifications persistent-elles une fois actionnées (exemple: approuver un member)?",
      "recommendation": "Ajouter un champ 'actionType' (null, 'approve', 'confirm', 'rate', etc.) et un champ 'actionCompleted' (boolean)."
    }
  ],
  "notification_types_implied_but_not_implemented": [
    {
      "type": "booking_confirmed",
      "description": "Confirmation d'une réservation (booking approuvé par le club)",
      "suggested_fields": [
        "type: 'booking_confirmed'",
        "bookingId",
        "clubId",
        "userId",
        "title",
        "message",
        "createdAt",
        "isRead"
      ],
      "referenced_in": "app/notifications.tsx (example: 'Réservation confirmée')",
      "should_be_created_in": "hooks/useUpdateBooking.ts lors de confirmBooking()"
    },
    {
      "type": "booking_rejected",
      "description": "Rejet d'une réservation avec raison",
      "suggested_fields": [
        "type: 'booking_rejected'",
        "bookingId",
        "clubId",
        "userId",
        "rejectionReason",
        "title",
        "message",
        "createdAt",
        "isRead"
      ],
      "referenced_in": "app/club-appointments.tsx (handleReject function)",
      "should_be_created_in": "hooks/useUpdateBooking.ts lors de rejectBooking()"
    },
    {
      "type": "event_created",
      "description": "Nouveau événement créé par un club",
      "suggested_fields": [
        "type: 'event_created'",
        "eventId",
        "clubId",
        "title",
        "message",
        "createdAt",
        "isRead"
      ],
      "referenced_in": "app/notifications.tsx (example: 'Nouvel événement')",
      "should_be_created_in": "app/club-events-management.tsx lors de handleCreate()"
    },
    {
      "type": "announcement_published",
      "description": "Nouvelle annonce publiée dans le club",
      "suggested_fields": [
        "type: 'announcement_published'",
        "clubId",
        "announcementId",
        "title",
        "message",
        "createdAt",
        "isRead"
      ],
      "referenced_in": "app/club-announcements.tsx",
      "should_be_created_in": "app/club-announcements.tsx lors de la publication"
    },
    {
      "type": "member_approved",
      "description": "Approbation d'une demande d'adhésion",
      "suggested_fields": [
        "type: 'member_approved'",
        "clubId",
        "userId",
        "recipientId",
        "title",
        "message",
        "createdAt",
        "isRead"
      ],
      "referenced_in": "hooks/useApproveOrRejectMember.ts",
      "should_be_created_in": "hooks/useApproveOrRejectMember.ts lors de approveOrRejectMember() avec action='approve'"
    },
    {
      "type": "member_rejected",
      "description": "Rejet d'une demande d'adhésion",
      "suggested_fields": [
        "type: 'member_rejected'",
        "clubId",
        "userId",
        "recipientId",
        "title",
        "message",
        "createdAt",
        "isRead"
      ],
      "referenced_in": "hooks/useApproveOrRejectMember.ts",
      "should_be_created_in": "hooks/useApproveOrRejectMember.ts lors de approveOrRejectMember() avec action='reject'"
    }
  ],
  "current_notification_creation_flows": [
    {
      "flow_name": "Join Club Request",
      "trigger": "User clicks 'Join Club' button",
      "flow": [
        "1. User calls useJoinClub().joinClub(input)",
        "2. Adds user to club.pendingMembers array",
        "3. Creates notification in 'notifications' collection with type='pending_member_request'",
        "4. Notification has: clubId, type, title, message, userId, userName, createdAt, read"
      ],
      "notification_recipient": "Club admin (via clubId)",
      "notification_display": "Not implemented - no hook listening to notifications collection",
      "files": [
        "hooks/useJoinClub.ts:67-75"
      ]
    },
    {
      "flow_name": "Member Approval",
      "trigger": "Club admin approves pending member",
      "flow": [
        "1. Admin calls useApproveOrRejectMember().approveOrRejectMember(input, action='approve')",
        "2. Removes member from pendingMembers",
        "3. Adds member to members array",
        "4. NO NOTIFICATION CREATED (BUG?)"
      ],
      "notification_recipient": "The approved user (should notify them)",
      "notification_display": "Missing - should notify user they're approved",
      "files": [
        "hooks/useApproveOrRejectMember.ts"
      ]
    },
    {
      "flow_name": "Mock Notifications Display",
      "trigger": "User navigates to Notifications screen",
      "flow": [
        "1. NotificationsScreen renders initialNotifications (hardcoded)",
        "2. Displays 4 example notifications",
        "3. Allows marking as read locally only",
        "4. Navigation based on type: rating -> ratingInvitation, club -> clubDetail"
      ],
      "notification_recipient": "All users (hardcoded examples)",
      "notification_display": "Fully implemented but with mock data",
      "files": [
        "app/notifications.tsx:15-62"
      ]
    }
  ],
  "database_schema_observations": {
    "collection_path": "notifications",
    "document_structure": {
      "status": "INCONSISTENT - Mixed schema between different notification types",
      "field_types": {
        "required_common_fields": [
          "type (string)",
          "createdAt (Timestamp)",
          "status_field_name (INCONSISTENT: 'read' vs 'isRead')"
        ],
        "optional_targeting_fields": [
          "clubId (string)",
          "userId (string)",
          "recipientId (string - MISSING)",
          "bookingId (string/number)",
          "eventId (string)"
        ],
        "optional_display_fields": [
          "title (string)",
          "message (string)",
          "icon (string - UI only)",
          "iconColor (string - UI only)",
          "bg (string - UI only)",
          "time (string - UI only)"
        ],
        "optional_action_fields": [
          "actionType (MISSING)",
          "actionCompleted (MISSING)",
          "targetRoute (MISSING)"
        ]
      }
    },
    "indexing_requirements": "Should add index on (clubId, createdAt) for querying club notifications",
    "partitioning_opportunity": "Could partition by clubId or userId for better query performance at scale"
  },
  "recommendations": [
    {
      "priority": "CRITICAL",
      "action": "Standardize read/isRead field naming",
      "details": "Change 'read' to 'isRead' in useJoinClub.ts and all notification creation code to match TypeScript conventions and frontend expectations.",
      "effort": "30 minutes",
      "files_to_modify": [
        "hooks/useJoinClub.ts"
      ]
    },
    {
      "priority": "CRITICAL",
      "action": "Implement real notifications listener in NotificationsScreen",
      "details": "Replace hardcoded initialNotifications with a real-time listener to the notifications collection. Filter by user role (admin vs regular user) and timestamp.",
      "effort": "2 hours",
      "files_to_modify": [
        "app/notifications.tsx"
      ],
      "suggested_hook": "useNotifications(userId, userRole) -> returns notifications[] and real-time updates"
    },
    {
      "priority": "HIGH",
      "action": "Create unified Notification interface in types/",
      "details": "Define a strict TypeScript interface for all notifications with required fields (type, createdAt, isRead, recipientId, targetId, targetType) and optional fields by type.",
      "effort": "1 hour",
      "files_to_create": [
        "types/Notification.ts"
      ],
      "example": "export type NotificationType = 'pending_member_request' | 'booking_confirmed' | 'rating_invite' | 'announcement' | etc."
    },
    {
      "priority": "HIGH",
      "action": "Add notification creation to all existing flows",
      "details": "Create notifications when: bookings confirmed/rejected, events created, announcements published, members approved/rejected.",
      "effort": "3 hours",
      "files_to_modify": [
        "hooks/useUpdateBooking.ts",
        "app/club-events-management.tsx",
        "app/club-announcements.tsx",
        "hooks/useApproveOrRejectMember.ts"
      ]
    },
    {
      "priority": "HIGH",
      "action": "Add recipient targeting to notifications",
      "details": "Add 'recipientId' and 'recipientRole' fields. Store notifications for specific users, not just by clubId. Implement proper query filtering.",
      "effort": "2 hours",
      "implementation": "When creating notification, determine if it's for an individual (recipientId) or all admins (recipientRole='admin')"
    },
    {
      "priority": "MEDIUM",
      "action": "Add action tracking to notifications",
      "details": "Add 'actionType' (e.g., 'approve_member', 'confirm_booking', 'rate_session') and 'actionCompleted' boolean to track which notifications have been acted upon.",
      "effort": "1 hour"
    },
    {
      "priority": "MEDIUM",
      "action": "Implement notification clear/archive functionality",
      "details": "Add ability to mark notifications as read/archived. Add UI buttons to delete notifications.",
      "effort": "1.5 hours",
      "files_to_modify": [
        "app/notifications.tsx",
        "Create useUpdateNotification.ts hook"
      ]
    },
    {
      "priority": "MEDIUM",
      "action": "Add Firestore security rules for notifications",
      "details": "Ensure users can only read their own notifications. Restrict notification creation to authenticated admin functions.",
      "effort": "30 minutes",
      "files_to_modify": [
        "firebase.rules (or Firestore rules in Firebase console)"
      ]
    },
    {
      "priority": "LOW",
      "action": "Add notification preferences/settings",
      "details": "Allow users to control which types of notifications they receive (email, push, in-app). Store in user profile.",
      "effort": "2 hours"
    }
  ],
  "summary": "La collection 'notifications' est actuellement en état d'ébauche. Une seule notification réelle est implémentée (pending_member_request) mais avec des incohérences de champs (read vs isRead). L'écran de notifications affiche uniquement des données mockées et n'écoute pas la collection Firestore réelle. Plusieurs fluxméritent de générer des notifications (approbations de membres, confirmations de réservations, événements) mais ne le font pas. La structure des données manque de cohérence et de champs permettant un ciblage d'utilisateurs approprié. Priorité absolue: standardiser le schéma, implémenter le listener temps réel, et ajouter les notifications manquantes dans les fluxexistants.",
  "estimated_total_remediation_effort": "12-15 hours"
}
